<script>
let strikes = 0;
let outlierSelected = false;
let gameOver = false;

fetch('puzzles.json')
.then(res => res.json())
.then(data => {

  const todayStr = new Date().toISOString().split('T')[0];

  let puzzle = data.find(p => p.date === todayStr);

  if (!puzzle) {
    puzzle = data[0]; // fallback
  }

  const board = puzzle.board.slice();
  shuffle(board);

  const grid = document.getElementById("grid");

  board.forEach(item => {
    const div = document.createElement("div");
    div.className = "tile";
    div.innerText = item;

    div.onclick = () => {
      if (outlierSelected || gameOver) return;

      if (item === puzzle.outlier) {
        div.classList.add("correct");
        outlierSelected = true;
        renderRules(puzzle);
      } else {
        div.classList.add("wrong");
        strikes++;
        checkGameOver();
      }
    };

    grid.appendChild(div);
  });

});

function renderRules(puzzle) {

  const rulesDiv = document.getElementById("rules");
  rulesDiv.innerHTML = "<h3>Which statement correctly describes the pattern?</h3>";

  const allRules = [puzzle.rule, ...puzzle.distractors];
  shuffle(allRules);

  allRules.forEach(ruleText => {

    const div = document.createElement("div");
    div.className = "rule-option";
    div.innerText = ruleText;

    div.onclick = () => {
      if (gameOver) return;

      if (ruleText === puzzle.rule) {
        document.getElementById("winModal").style.display = "flex";
        gameOver = true;
      } else {
        strikes++;
        checkGameOver();
      }
    };

    rulesDiv.appendChild(div);
  });

  document.getElementById("ruleSection").style.display = "block";
}

function checkGameOver() {
  if (strikes >= 3) {
    gameOver = true;
    document.getElementById("loseModal").style.display = "flex";
  }
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}
</script>
